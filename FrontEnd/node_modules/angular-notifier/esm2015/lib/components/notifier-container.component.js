import { ChangeDetectionStrategy, ChangeDetectorRef, Component } from '@angular/core';
import { NotifierNotification } from '../models/notifier-notification.model';
import { NotifierService } from '../services/notifier.service';
import { NotifierQueueService } from '../services/notifier-queue.service';
/**
 * Notifier container component
 * ----------------------------
 * This component acts as a wrapper for all notification components; consequently, it is responsible for creating a new notification
 * component and removing an existing notification component. Being more precicely, it also handles side effects of those actions, such as
 * shifting or even completely removing other notifications as well. Overall, this components handles actions coming from the queue service
 * by subscribing to its action stream.
 *
 * Technical sidenote:
 * This component has to be used somewhere in an application to work; it will not inject and create itself automatically, primarily in order
 * to not break the Angular AoT compilation. Moreover, this component (and also the notification components) set their change detection
 * strategy onPush, which means that we handle change detection manually in order to get the best performance. (#perfmatters)
 */
export class NotifierContainerComponent {
    /**
     * Constructor
     *
     * @param changeDetector       Change detector, used for manually triggering change detection runs
     * @param notifierQueueService Notifier queue service
     * @param notifierService      Notifier service
     */
    constructor(changeDetector, notifierQueueService, notifierService) {
        this.changeDetector = changeDetector;
        this.queueService = notifierQueueService;
        this.config = notifierService.getConfig();
        this.notifications = [];
        // Connects this component up to the action queue, then handle incoming actions
        this.queueServiceSubscription = this.queueService.actionStream.subscribe((action) => {
            this.handleAction(action).then(() => {
                this.queueService.continue();
            });
        });
    }
    /**
     * Component destroyment lifecycle hook, cleans up the observable subsciption
     */
    ngOnDestroy() {
        if (this.queueServiceSubscription) {
            this.queueServiceSubscription.unsubscribe();
        }
    }
    /**
     * Notification identifier, used as the ngFor trackby function
     *
     * @param   index        Index
     * @param   notification Notifier notification
     * @returns Notification ID as the unique identnfier
     */
    identifyNotification(index, notification) {
        return notification.id;
    }
    /**
     * Event handler, handles clicks on notification dismiss buttons
     *
     * @param notificationId ID of the notification to dismiss
     */
    onNotificationDismiss(notificationId) {
        this.queueService.push({
            payload: notificationId,
            type: 'HIDE',
        });
    }
    /**
     * Event handler, handles notification ready events
     *
     * @param notificationComponent Notification component reference
     */
    onNotificationReady(notificationComponent) {
        const currentNotification = this.notifications[this.notifications.length - 1]; // Get the latest notification
        currentNotification.component = notificationComponent; // Save the new omponent reference
        this.continueHandleShowAction(currentNotification); // Continue with handling the show action
    }
    /**
     * Handle incoming actions by mapping action types to methods, and then running them
     *
     * @param   action Action object
     * @returns Promise, resolved when done
     */
    handleAction(action) {
        switch (action.type // TODO: Maybe a map (actionType -> class method) is a cleaner solution here?
        ) {
            case 'SHOW':
                return this.handleShowAction(action);
            case 'HIDE':
                return this.handleHideAction(action);
            case 'HIDE_OLDEST':
                return this.handleHideOldestAction(action);
            case 'HIDE_NEWEST':
                return this.handleHideNewestAction(action);
            case 'HIDE_ALL':
                return this.handleHideAllAction();
            default:
                return new Promise((resolve) => {
                    resolve(); // Ignore unknown action types
                });
        }
    }
    /**
     * Show a new notification
     *
     * We simply add the notification to the list, and then wait until its properly initialized / created / rendered.
     *
     * @param   action Action object
     * @returns Promise, resolved when done
     */
    handleShowAction(action) {
        return new Promise((resolve) => {
            this.tempPromiseResolver = resolve; // Save the promise resolve function so that it can be called later on by another method
            this.addNotificationToList(new NotifierNotification(action.payload));
        });
    }
    /**
     * Continue to show a new notification (after the notification components is initialized / created / rendered).
     *
     * If this is the first (and thus only) notification, we can simply show it. Otherwhise, if stacking is disabled (or a low value), we
     * switch out notifications, in particular we hide the existing one, and then show our new one. Yet, if stacking is enabled, we first
     * shift all older notifications, and then show our new notification. In addition, if there are too many notification on the screen,
     * we hide the oldest one first. Furthermore, if configured, animation overlapping is applied.
     *
     * @param notification New notification to show
     */
    continueHandleShowAction(notification) {
        // First (which means only one) notification in the list?
        const numberOfNotifications = this.notifications.length;
        if (numberOfNotifications === 1) {
            notification.component.show().then(this.tempPromiseResolver); // Done
        }
        else {
            const implicitStackingLimit = 2;
            // Stacking enabled? (stacking value below 2 means stacking is disabled)
            if (this.config.behaviour.stacking === false || this.config.behaviour.stacking < implicitStackingLimit) {
                this.notifications[0].component.hide().then(() => {
                    this.removeNotificationFromList(this.notifications[0]);
                    notification.component.show().then(this.tempPromiseResolver); // Done
                });
            }
            else {
                const stepPromises = [];
                // Are there now too many notifications?
                if (numberOfNotifications > this.config.behaviour.stacking) {
                    const oldNotifications = this.notifications.slice(1, numberOfNotifications - 1);
                    // Are animations enabled?
                    if (this.config.animations.enabled) {
                        // Is animation overlap enabled?
                        if (this.config.animations.overlap !== false && this.config.animations.overlap > 0) {
                            stepPromises.push(this.notifications[0].component.hide());
                            setTimeout(() => {
                                stepPromises.push(this.shiftNotifications(oldNotifications, notification.component.getHeight(), true));
                            }, this.config.animations.hide.speed - this.config.animations.overlap);
                            setTimeout(() => {
                                stepPromises.push(notification.component.show());
                            }, this.config.animations.hide.speed + this.config.animations.shift.speed - this.config.animations.overlap);
                        }
                        else {
                            stepPromises.push(new Promise((resolve) => {
                                this.notifications[0].component.hide().then(() => {
                                    this.shiftNotifications(oldNotifications, notification.component.getHeight(), true).then(() => {
                                        notification.component.show().then(resolve);
                                    });
                                });
                            }));
                        }
                    }
                    else {
                        stepPromises.push(this.notifications[0].component.hide());
                        stepPromises.push(this.shiftNotifications(oldNotifications, notification.component.getHeight(), true));
                        stepPromises.push(notification.component.show());
                    }
                }
                else {
                    const oldNotifications = this.notifications.slice(0, numberOfNotifications - 1);
                    // Are animations enabled?
                    if (this.config.animations.enabled) {
                        // Is animation overlap enabled?
                        if (this.config.animations.overlap !== false && this.config.animations.overlap > 0) {
                            stepPromises.push(this.shiftNotifications(oldNotifications, notification.component.getHeight(), true));
                            setTimeout(() => {
                                stepPromises.push(notification.component.show());
                            }, this.config.animations.shift.speed - this.config.animations.overlap);
                        }
                        else {
                            stepPromises.push(new Promise((resolve) => {
                                this.shiftNotifications(oldNotifications, notification.component.getHeight(), true).then(() => {
                                    notification.component.show().then(resolve);
                                });
                            }));
                        }
                    }
                    else {
                        stepPromises.push(this.shiftNotifications(oldNotifications, notification.component.getHeight(), true));
                        stepPromises.push(notification.component.show());
                    }
                }
                Promise.all(stepPromises).then(() => {
                    if (numberOfNotifications > this.config.behaviour.stacking) {
                        this.removeNotificationFromList(this.notifications[0]);
                    }
                    this.tempPromiseResolver();
                }); // Done
            }
        }
    }
    /**
     * Hide an existing notification
     *
     * Fist, we skip everything if there are no notifications at all, or the given notification does not exist. Then, we hide the given
     * notification. If there exist older notifications, we then shift them around to fill the gap. Once both hiding the given notification
     * and shifting the older notificaitons is done, the given notification gets finally removed (from the DOM).
     *
     * @param   action Action object, payload contains the notification ID
     * @returns Promise, resolved when done
     */
    handleHideAction(action) {
        return new Promise((resolve) => {
            const stepPromises = [];
            // Does the notification exist / are there even any notifications? (let's prevent accidential errors)
            const notification = this.findNotificationById(action.payload);
            if (notification === undefined) {
                resolve();
                return;
            }
            // Get older notifications
            const notificationIndex = this.findNotificationIndexById(action.payload);
            if (notificationIndex === undefined) {
                resolve();
                return;
            }
            const oldNotifications = this.notifications.slice(0, notificationIndex);
            // Do older notifications exist, and thus do we need to shift other notifications as a consequence?
            if (oldNotifications.length > 0) {
                // Are animations enabled?
                if (this.config.animations.enabled && this.config.animations.hide.speed > 0) {
                    // Is animation overlap enabled?
                    if (this.config.animations.overlap !== false && this.config.animations.overlap > 0) {
                        stepPromises.push(notification.component.hide());
                        setTimeout(() => {
                            stepPromises.push(this.shiftNotifications(oldNotifications, notification.component.getHeight(), false));
                        }, this.config.animations.hide.speed - this.config.animations.overlap);
                    }
                    else {
                        notification.component.hide().then(() => {
                            stepPromises.push(this.shiftNotifications(oldNotifications, notification.component.getHeight(), false));
                        });
                    }
                }
                else {
                    stepPromises.push(notification.component.hide());
                    stepPromises.push(this.shiftNotifications(oldNotifications, notification.component.getHeight(), false));
                }
            }
            else {
                stepPromises.push(notification.component.hide());
            }
            // Wait until both hiding and shifting is done, then remove the notification from the list
            Promise.all(stepPromises).then(() => {
                this.removeNotificationFromList(notification);
                resolve(); // Done
            });
        });
    }
    /**
     * Hide the oldest notification (bridge to handleHideAction)
     *
     * @param   action Action object
     * @returns Promise, resolved when done
     */
    handleHideOldestAction(action) {
        // Are there any notifications? (prevent accidential errors)
        if (this.notifications.length === 0) {
            return new Promise((resolve) => {
                resolve();
            }); // Done
        }
        else {
            action.payload = this.notifications[0].id;
            return this.handleHideAction(action);
        }
    }
    /**
     * Hide the newest notification (bridge to handleHideAction)
     *
     * @param   action Action object
     * @returns Promise, resolved when done
     */
    handleHideNewestAction(action) {
        // Are there any notifications? (prevent accidential errors)
        if (this.notifications.length === 0) {
            return new Promise((resolve) => {
                resolve();
            }); // Done
        }
        else {
            action.payload = this.notifications[this.notifications.length - 1].id;
            return this.handleHideAction(action);
        }
    }
    /**
     * Hide all notifications at once
     *
     * @returns Promise, resolved when done
     */
    handleHideAllAction() {
        return new Promise((resolve) => {
            // Are there any notifications? (prevent accidential errors)
            const numberOfNotifications = this.notifications.length;
            if (numberOfNotifications === 0) {
                resolve(); // Done
                return;
            }
            // Are animations enabled?
            if (this.config.animations.enabled &&
                this.config.animations.hide.speed > 0 &&
                this.config.animations.hide.offset !== false &&
                this.config.animations.hide.offset > 0) {
                for (let i = numberOfNotifications - 1; i >= 0; i--) {
                    const animationOffset = this.config.position.vertical.position === 'top' ? numberOfNotifications - 1 : i;
                    setTimeout(() => {
                        this.notifications[i].component.hide().then(() => {
                            // Are we done here, was this the last notification to be hidden?
                            if ((this.config.position.vertical.position === 'top' && i === 0) ||
                                (this.config.position.vertical.position === 'bottom' && i === numberOfNotifications - 1)) {
                                this.removeAllNotificationsFromList();
                                resolve(); // Done
                            }
                        });
                    }, this.config.animations.hide.offset * animationOffset);
                }
            }
            else {
                const stepPromises = [];
                for (let i = numberOfNotifications - 1; i >= 0; i--) {
                    stepPromises.push(this.notifications[i].component.hide());
                }
                Promise.all(stepPromises).then(() => {
                    this.removeAllNotificationsFromList();
                    resolve(); // Done
                });
            }
        });
    }
    /**
     * Shift multiple notifications at once
     *
     * @param   notifications List containing the notifications to be shifted
     * @param   distance      Distance to shift (in px)
     * @param   toMakePlace   Flag, defining in which direciton to shift
     * @returns Promise, resolved when done
     */
    shiftNotifications(notifications, distance, toMakePlace) {
        return new Promise((resolve) => {
            // Are there any notifications to shift?
            if (notifications.length === 0) {
                resolve();
                return;
            }
            const notificationPromises = [];
            for (let i = notifications.length - 1; i >= 0; i--) {
                notificationPromises.push(notifications[i].component.shift(distance, toMakePlace));
            }
            Promise.all(notificationPromises).then(resolve); // Done
        });
    }
    /**
     * Add a new notification to the list of notifications (triggers change detection)
     *
     * @param notification Notification to add to the list of notifications
     */
    addNotificationToList(notification) {
        this.notifications.push(notification);
        this.changeDetector.markForCheck(); // Run change detection because the notification list changed
    }
    /**
     * Remove an existing notification from the list of notifications (triggers change detection)
     *
     * @param notification Notification to be removed from the list of notifications
     */
    removeNotificationFromList(notification) {
        this.notifications = this.notifications.filter((item) => item.component !== notification.component);
        this.changeDetector.markForCheck(); // Run change detection because the notification list changed
    }
    /**
     * Remove all notifications from the list (triggers change detection)
     */
    removeAllNotificationsFromList() {
        this.notifications = [];
        this.changeDetector.markForCheck(); // Run change detection because the notification list changed
    }
    /**
     * Helper: Find a notification in the notification list by a given notification ID
     *
     * @param   notificationId Notification ID, used for finding notification
     * @returns Notification, undefined if not found
     */
    findNotificationById(notificationId) {
        return this.notifications.find((currentNotification) => currentNotification.id === notificationId);
    }
    /**
     * Helper: Find a notification's index by a given notification ID
     *
     * @param   notificationId Notification ID, used for finding a notification's index
     * @returns Notification index, undefined if not found
     */
    findNotificationIndexById(notificationId) {
        const notificationIndex = this.notifications.findIndex((currentNotification) => currentNotification.id === notificationId);
        return notificationIndex !== -1 ? notificationIndex : undefined;
    }
}
NotifierContainerComponent.decorators = [
    { type: Component, args: [{
                changeDetection: ChangeDetectionStrategy.OnPush,
                host: {
                    class: 'notifier__container',
                },
                selector: 'notifier-container',
                template: "<ul class=\"notifier__container-list\">\n  <li class=\"notifier__container-list-item\" *ngFor=\"let notification of notifications; trackBy: identifyNotification\">\n    <notifier-notification [notification]=\"notification\" (ready)=\"onNotificationReady($event)\" (dismiss)=\"onNotificationDismiss($event)\">\n    </notifier-notification>\n  </li>\n</ul>\n"
            },] }
];
NotifierContainerComponent.ctorParameters = () => [
    { type: ChangeDetectorRef },
    { type: NotifierQueueService },
    { type: NotifierService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm90aWZpZXItY29udGFpbmVyLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2FuZ3VsYXItbm90aWZpZXIvc3JjL2xpYi9jb21wb25lbnRzL25vdGlmaWVyLWNvbnRhaW5lci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLHVCQUF1QixFQUFFLGlCQUFpQixFQUFFLFNBQVMsRUFBYSxNQUFNLGVBQWUsQ0FBQztBQUtqRyxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSx1Q0FBdUMsQ0FBQztBQUM3RSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDL0QsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sb0NBQW9DLENBQUM7QUFHMUU7Ozs7Ozs7Ozs7OztHQVlHO0FBU0gsTUFBTSxPQUFPLDBCQUEwQjtJQStCckM7Ozs7OztPQU1HO0lBQ0gsWUFBbUIsY0FBaUMsRUFBRSxvQkFBMEMsRUFBRSxlQUFnQztRQUNoSSxJQUFJLENBQUMsY0FBYyxHQUFHLGNBQWMsQ0FBQztRQUNyQyxJQUFJLENBQUMsWUFBWSxHQUFHLG9CQUFvQixDQUFDO1FBQ3pDLElBQUksQ0FBQyxNQUFNLEdBQUcsZUFBZSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQzFDLElBQUksQ0FBQyxhQUFhLEdBQUcsRUFBRSxDQUFDO1FBRXhCLCtFQUErRTtRQUMvRSxJQUFJLENBQUMsd0JBQXdCLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLENBQUMsTUFBc0IsRUFBRSxFQUFFO1lBQ2xHLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRTtnQkFDbEMsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUMvQixDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQyxD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LEVBQUUsdUJBQXVCLENBQUMsTUFBTTtnQkFDL0MsSUFBSSxFQUFFO29CQUNKLEtBQUssRUFBRSxxQkFBcUI7aUJBQzdCO2dCQUNELFFBQVEsRUFBRSxvQkFBb0I7Z0JBQzlCLGdYQUFrRDthQUNuRDs7O1lBOUJpQyxpQkFBaUI7WUFPMUMsb0JBQW9CO1lBRHBCLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSwgQ2hhbmdlRGV0ZWN0b3JSZWYsIENvbXBvbmVudCwgT25EZXN0cm95IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHsgTm90aWZpZXJBY3Rpb24gfSBmcm9tICcuLi9tb2RlbHMvbm90aWZpZXItYWN0aW9uLm1vZGVsJztcbmltcG9ydCB7IE5vdGlmaWVyQ29uZmlnIH0gZnJvbSAnLi4vbW9kZWxzL25vdGlmaWVyLWNvbmZpZy5tb2RlbCc7XG5pbXBvcnQgeyBOb3RpZmllck5vdGlmaWNhdGlvbiB9IGZyb20gJy4uL21vZGVscy9ub3RpZmllci1ub3RpZmljYXRpb24ubW9kZWwnO1xuaW1wb3J0IHsgTm90aWZpZXJTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvbm90aWZpZXIuc2VydmljZSc7XG5pbXBvcnQgeyBOb3RpZmllclF1ZXVlU2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2VzL25vdGlmaWVyLXF1ZXVlLnNlcnZpY2UnO1xuaW1wb3J0IHsgTm90aWZpZXJOb3RpZmljYXRpb25Db21wb25lbnQgfSBmcm9tICcuL25vdGlmaWVyLW5vdGlmaWNhdGlvbi5jb21wb25lbnQnO1xuXG4vKipcbiAqIE5vdGlmaWVyIGNvbnRhaW5lciBjb21wb25lbnRcbiAqIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAqIFRoaXMgY29tcG9uZW50IGFjdHMgYXMgYSB3cmFwcGVyIGZvciBhbGwgbm90aWZpY2F0aW9uIGNvbXBvbmVudHM7IGNvbnNlcXVlbnRseSwgaXQgaXMgcmVzcG9uc2libGUgZm9yIGNyZWF0aW5nIGEgbmV3IG5vdGlmaWNhdGlvblxuICogY29tcG9uZW50IGFuZCByZW1vdmluZyBhbiBleGlzdGluZyBub3RpZmljYXRpb24gY29tcG9uZW50LiBCZWluZyBtb3JlIHByZWNpY2VseSwgaXQgYWxzbyBoYW5kbGVzIHNpZGUgZWZmZWN0cyBvZiB0aG9zZSBhY3Rpb25zLCBzdWNoIGFzXG4gKiBzaGlmdGluZyBvciBldmVuIGNvbXBsZXRlbHkgcmVtb3Zpbmcgb3RoZXIgbm90aWZpY2F0aW9ucyBhcyB3ZWxsLiBPdmVyYWxsLCB0aGlzIGNvbXBvbmVudHMgaGFuZGxlcyBhY3Rpb25zIGNvbWluZyBmcm9tIHRoZSBxdWV1ZSBzZXJ2aWNlXG4gKiBieSBzdWJzY3JpYmluZyB0byBpdHMgYWN0aW9uIHN0cmVhbS5cbiAqXG4gKiBUZWNobmljYWwgc2lkZW5vdGU6XG4gKiBUaGlzIGNvbXBvbmVudCBoYXMgdG8gYmUgdXNlZCBzb21ld2hlcmUgaW4gYW4gYXBwbGljYXRpb24gdG8gd29yazsgaXQgd2lsbCBub3QgaW5qZWN0IGFuZCBjcmVhdGUgaXRzZWxmIGF1dG9tYXRpY2FsbHksIHByaW1hcmlseSBpbiBvcmRlclxuICogdG8gbm90IGJyZWFrIHRoZSBBbmd1bGFyIEFvVCBjb21waWxhdGlvbi4gTW9yZW92ZXIsIHRoaXMgY29tcG9uZW50IChhbmQgYWxzbyB0aGUgbm90aWZpY2F0aW9uIGNvbXBvbmVudHMpIHNldCB0aGVpciBjaGFuZ2UgZGV0ZWN0aW9uXG4gKiBzdHJhdGVneSBvblB1c2gsIHdoaWNoIG1lYW5zIHRoYXQgd2UgaGFuZGxlIGNoYW5nZSBkZXRlY3Rpb24gbWFudWFsbHkgaW4gb3JkZXIgdG8gZ2V0IHRoZSBiZXN0IHBlcmZvcm1hbmNlLiAoI3BlcmZtYXR0ZXJzKVxuICovXG5AQ29tcG9uZW50KHtcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsIC8vICgjcGVyZm1hdHRlcnMpXG4gIGhvc3Q6IHtcbiAgICBjbGFzczogJ25vdGlmaWVyX19jb250YWluZXInLFxuICB9LFxuICBzZWxlY3RvcjogJ25vdGlmaWVyLWNvbnRhaW5lcicsXG4gIHRlbXBsYXRlVXJsOiAnLi9ub3RpZmllci1jb250YWluZXIuY29tcG9uZW50Lmh0bWwnLFxufSlcbmV4cG9ydCBjbGFzcyBOb3RpZmllckNvbnRhaW5lckNvbXBvbmVudCBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG4gIC8qKlxuICAgKiBMaXN0IG9mIGN1cnJlbnRseSBzb21ld2hhdCBhY3RpdmUgbm90aWZpY2F0aW9uc1xuICAgKi9cbiAgcHVibGljIG5vdGlmaWNhdGlvbnM6IEFycmF5PE5vdGlmaWVyTm90aWZpY2F0aW9uPjtcblxuICAvKipcbiAgICogQ2hhbmdlIGRldGVjdG9yXG4gICAqL1xuICBwcml2YXRlIHJlYWRvbmx5IGNoYW5nZURldGVjdG9yOiBDaGFuZ2VEZXRlY3RvclJlZjtcblxuICAvKipcbiAgICogTm90aWZpZXIgcXVldWUgc2VydmljZVxuICAgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBxdWV1ZVNlcnZpY2U6IE5vdGlmaWVyUXVldWVTZXJ2aWNlO1xuXG4gIC8qKlxuICAgKiBOb3RpZmllciBjb25maWd1cmF0aW9uXG4gICAqL1xuICBwcml2YXRlIHJlYWRvbmx5IGNvbmZpZzogTm90aWZpZXJDb25maWc7XG5cbiAgLyoqXG4gICAqIFF1ZXVlIHNlcnZpY2Ugb2JzZXJ2YWJsZSBzdWJzY3JpcHRpb24gKHNhdmVkIGZvciBjbGVhbnVwKVxuICAgKi9cbiAgcHJpdmF0ZSBxdWV1ZVNlcnZpY2VTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcblxuICAvKipcbiAgICogUHJvbWlzZSByZXNvbHZlIGZ1bmN0aW9uIHJlZmVyZW5jZSwgdGVtcG9yYXJpbHkgdXNlZCB3aGlsZSB0aGUgbm90aWZpY2F0aW9uIGNoaWxkIGNvbXBvbmVudCBnZXRzIGNyZWF0ZWRcbiAgICovXG4gIHByaXZhdGUgdGVtcFByb21pc2VSZXNvbHZlcjogKCkgPT4gdm9pZDtcblxuICAvKipcbiAgICogQ29uc3RydWN0b3JcbiAgICpcbiAgICogQHBhcmFtIGNoYW5nZURldGVjdG9yICAgICAgIENoYW5nZSBkZXRlY3RvciwgdXNlZCBmb3IgbWFudWFsbHkgdHJpZ2dlcmluZyBjaGFuZ2UgZGV0ZWN0aW9uIHJ1bnNcbiAgICogQHBhcmFtIG5vdGlmaWVyUXVldWVTZXJ2aWNlIE5vdGlmaWVyIHF1ZXVlIHNlcnZpY2VcbiAgICogQHBhcmFtIG5vdGlmaWVyU2VydmljZSAgICAgIE5vdGlmaWVyIHNlcnZpY2VcbiAgICovXG4gIHB1YmxpYyBjb25zdHJ1Y3RvcihjaGFuZ2VEZXRlY3RvcjogQ2hhbmdlRGV0ZWN0b3JSZWYsIG5vdGlmaWVyUXVldWVTZXJ2aWNlOiBOb3RpZmllclF1ZXVlU2VydmljZSwgbm90aWZpZXJTZXJ2aWNlOiBOb3RpZmllclNlcnZpY2UpIHtcbiAgICB0aGlzLmNoYW5nZURldGVjdG9yID0gY2hhbmdlRGV0ZWN0b3I7XG4gICAgdGhpcy5xdWV1ZVNlcnZpY2UgPSBub3RpZmllclF1ZXVlU2VydmljZTtcbiAgICB0aGlzLmNvbmZpZyA9IG5vdGlmaWVyU2VydmljZS5nZXRDb25maWcoKTtcbiAgICB0aGlzLm5vdGlmaWNhdGlvbnMgPSBbXTtcblxuICAgIC8vIENvbm5lY3RzIHRoaXMgY29tcG9uZW50IHVwIHRvIHRoZSBhY3Rpb24gcXVldWUsIHRoZW4gaGFuZGxlIGluY29taW5nIGFjdGlvbnNcbiAgICB0aGlzLnF1ZXVlU2VydmljZVN1YnNjcmlwdGlvbiA9IHRoaXMucXVldWVTZXJ2aWNlLmFjdGlvblN0cmVhbS5zdWJzY3JpYmUoKGFjdGlvbjogTm90aWZpZXJBY3Rpb24pID0+IHtcbiAgICAgIHRoaXMuaGFuZGxlQWN0aW9uKGFjdGlvbikudGhlbigoKSA9PiB7XG4gICAgICAgIHRoaXMucXVldWVTZXJ2aWNlLmNvbnRpbnVlKCk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb21wb25lbnQgZGVzdHJveW1lbnQgbGlmZWN5Y2xlIGhvb2ssIGNsZWFucyB1cCB0aGUgb2JzZXJ2YWJsZSBzdWJzY2lwdGlvblxuICAgKi9cbiAgcHVibGljIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIGlmICh0aGlzLnF1ZXVlU2VydmljZVN1YnNjcmlwdGlvbikge1xuICAgICAgdGhpcy5xdWV1ZVNlcnZpY2VTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogTm90aWZpY2F0aW9uIGlkZW50aWZpZXIsIHVzZWQgYXMgdGhlIG5nRm9yIHRyYWNrYnkgZnVuY3Rpb25cbiAgICpcbiAgICogQHBhcmFtICAgaW5kZXggICAgICAgIEluZGV4XG4gICAqIEBwYXJhbSAgIG5vdGlmaWNhdGlvbiBOb3RpZmllciBub3RpZmljYXRpb25cbiAgICogQHJldHVybnMgTm90aWZpY2F0aW9uIElEIGFzIHRoZSB1bmlxdWUgaWRlbnRuZmllclxuICAgKi9cbiAgcHVibGljIGlkZW50aWZ5Tm90aWZpY2F0aW9uKGluZGV4OiBudW1iZXIsIG5vdGlmaWNhdGlvbjogTm90aWZpZXJOb3RpZmljYXRpb24pOiBzdHJpbmcge1xuICAgIHJldHVybiBub3RpZmljYXRpb24uaWQ7XG4gIH1cblxuICAvKipcbiAgICogRXZlbnQgaGFuZGxlciwgaGFuZGxlcyBjbGlja3Mgb24gbm90aWZpY2F0aW9uIGRpc21pc3MgYnV0dG9uc1xuICAgKlxuICAgKiBAcGFyYW0gbm90aWZpY2F0aW9uSWQgSUQgb2YgdGhlIG5vdGlmaWNhdGlvbiB0byBkaXNtaXNzXG4gICAqL1xuICBwdWJsaWMgb25Ob3RpZmljYXRpb25EaXNtaXNzKG5vdGlmaWNhdGlvbklkOiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLnF1ZXVlU2VydmljZS5wdXNoKHtcbiAgICAgIHBheWxvYWQ6IG5vdGlmaWNhdGlvbklkLFxuICAgICAgdHlwZTogJ0hJREUnLFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEV2ZW50IGhhbmRsZXIsIGhhbmRsZXMgbm90aWZpY2F0aW9uIHJlYWR5IGV2ZW50c1xuICAgKlxuICAgKiBAcGFyYW0gbm90aWZpY2F0aW9uQ29tcG9uZW50IE5vdGlmaWNhdGlvbiBjb21wb25lbnQgcmVmZXJlbmNlXG4gICAqL1xuICBwdWJsaWMgb25Ob3RpZmljYXRpb25SZWFkeShub3RpZmljYXRpb25Db21wb25lbnQ6IE5vdGlmaWVyTm90aWZpY2F0aW9uQ29tcG9uZW50KTogdm9pZCB7XG4gICAgY29uc3QgY3VycmVudE5vdGlmaWNhdGlvbjogTm90aWZpZXJOb3RpZmljYXRpb24gPSB0aGlzLm5vdGlmaWNhdGlvbnNbdGhpcy5ub3RpZmljYXRpb25zLmxlbmd0aCAtIDFdOyAvLyBHZXQgdGhlIGxhdGVzdCBub3RpZmljYXRpb25cbiAgICBjdXJyZW50Tm90aWZpY2F0aW9uLmNvbXBvbmVudCA9IG5vdGlmaWNhdGlvbkNvbXBvbmVudDsgLy8gU2F2ZSB0aGUgbmV3IG9tcG9uZW50IHJlZmVyZW5jZVxuICAgIHRoaXMuY29udGludWVIYW5kbGVTaG93QWN0aW9uKGN1cnJlbnROb3RpZmljYXRpb24pOyAvLyBDb250aW51ZSB3aXRoIGhhbmRsaW5nIHRoZSBzaG93IGFjdGlvblxuICB9XG5cbiAgLyoqXG4gICAqIEhhbmRsZSBpbmNvbWluZyBhY3Rpb25zIGJ5IG1hcHBpbmcgYWN0aW9uIHR5cGVzIHRvIG1ldGhvZHMsIGFuZCB0aGVuIHJ1bm5pbmcgdGhlbVxuICAgKlxuICAgKiBAcGFyYW0gICBhY3Rpb24gQWN0aW9uIG9iamVjdFxuICAgKiBAcmV0dXJucyBQcm9taXNlLCByZXNvbHZlZCB3aGVuIGRvbmVcbiAgICovXG4gIHByaXZhdGUgaGFuZGxlQWN0aW9uKGFjdGlvbjogTm90aWZpZXJBY3Rpb24pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBzd2l0Y2ggKFxuICAgICAgYWN0aW9uLnR5cGUgLy8gVE9ETzogTWF5YmUgYSBtYXAgKGFjdGlvblR5cGUgLT4gY2xhc3MgbWV0aG9kKSBpcyBhIGNsZWFuZXIgc29sdXRpb24gaGVyZT9cbiAgICApIHtcbiAgICAgIGNhc2UgJ1NIT1cnOlxuICAgICAgICByZXR1cm4gdGhpcy5oYW5kbGVTaG93QWN0aW9uKGFjdGlvbik7XG4gICAgICBjYXNlICdISURFJzpcbiAgICAgICAgcmV0dXJuIHRoaXMuaGFuZGxlSGlkZUFjdGlvbihhY3Rpb24pO1xuICAgICAgY2FzZSAnSElERV9PTERFU1QnOlxuICAgICAgICByZXR1cm4gdGhpcy5oYW5kbGVIaWRlT2xkZXN0QWN0aW9uKGFjdGlvbik7XG4gICAgICBjYXNlICdISURFX05FV0VTVCc6XG4gICAgICAgIHJldHVybiB0aGlzLmhhbmRsZUhpZGVOZXdlc3RBY3Rpb24oYWN0aW9uKTtcbiAgICAgIGNhc2UgJ0hJREVfQUxMJzpcbiAgICAgICAgcmV0dXJuIHRoaXMuaGFuZGxlSGlkZUFsbEFjdGlvbigpO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlOiAoKSA9PiB2b2lkKSA9PiB7XG4gICAgICAgICAgcmVzb2x2ZSgpOyAvLyBJZ25vcmUgdW5rbm93biBhY3Rpb24gdHlwZXNcbiAgICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNob3cgYSBuZXcgbm90aWZpY2F0aW9uXG4gICAqXG4gICAqIFdlIHNpbXBseSBhZGQgdGhlIG5vdGlmaWNhdGlvbiB0byB0aGUgbGlzdCwgYW5kIHRoZW4gd2FpdCB1bnRpbCBpdHMgcHJvcGVybHkgaW5pdGlhbGl6ZWQgLyBjcmVhdGVkIC8gcmVuZGVyZWQuXG4gICAqXG4gICAqIEBwYXJhbSAgIGFjdGlvbiBBY3Rpb24gb2JqZWN0XG4gICAqIEByZXR1cm5zIFByb21pc2UsIHJlc29sdmVkIHdoZW4gZG9uZVxuICAgKi9cbiAgcHJpdmF0ZSBoYW5kbGVTaG93QWN0aW9uKGFjdGlvbjogTm90aWZpZXJBY3Rpb24pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmU6ICgpID0+IHZvaWQpID0+IHtcbiAgICAgIHRoaXMudGVtcFByb21pc2VSZXNvbHZlciA9IHJlc29sdmU7IC8vIFNhdmUgdGhlIHByb21pc2UgcmVzb2x2ZSBmdW5jdGlvbiBzbyB0aGF0IGl0IGNhbiBiZSBjYWxsZWQgbGF0ZXIgb24gYnkgYW5vdGhlciBtZXRob2RcbiAgICAgIHRoaXMuYWRkTm90aWZpY2F0aW9uVG9MaXN0KG5ldyBOb3RpZmllck5vdGlmaWNhdGlvbihhY3Rpb24ucGF5bG9hZCkpO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbnRpbnVlIHRvIHNob3cgYSBuZXcgbm90aWZpY2F0aW9uIChhZnRlciB0aGUgbm90aWZpY2F0aW9uIGNvbXBvbmVudHMgaXMgaW5pdGlhbGl6ZWQgLyBjcmVhdGVkIC8gcmVuZGVyZWQpLlxuICAgKlxuICAgKiBJZiB0aGlzIGlzIHRoZSBmaXJzdCAoYW5kIHRodXMgb25seSkgbm90aWZpY2F0aW9uLCB3ZSBjYW4gc2ltcGx5IHNob3cgaXQuIE90aGVyd2hpc2UsIGlmIHN0YWNraW5nIGlzIGRpc2FibGVkIChvciBhIGxvdyB2YWx1ZSksIHdlXG4gICAqIHN3aXRjaCBvdXQgbm90aWZpY2F0aW9ucywgaW4gcGFydGljdWxhciB3ZSBoaWRlIHRoZSBleGlzdGluZyBvbmUsIGFuZCB0aGVuIHNob3cgb3VyIG5ldyBvbmUuIFlldCwgaWYgc3RhY2tpbmcgaXMgZW5hYmxlZCwgd2UgZmlyc3RcbiAgICogc2hpZnQgYWxsIG9sZGVyIG5vdGlmaWNhdGlvbnMsIGFuZCB0aGVuIHNob3cgb3VyIG5ldyBub3RpZmljYXRpb24uIEluIGFkZGl0aW9uLCBpZiB0aGVyZSBhcmUgdG9vIG1hbnkgbm90aWZpY2F0aW9uIG9uIHRoZSBzY3JlZW4sXG4gICAqIHdlIGhpZGUgdGhlIG9sZGVzdCBvbmUgZmlyc3QuIEZ1cnRoZXJtb3JlLCBpZiBjb25maWd1cmVkLCBhbmltYXRpb24gb3ZlcmxhcHBpbmcgaXMgYXBwbGllZC5cbiAgICpcbiAgICogQHBhcmFtIG5vdGlmaWNhdGlvbiBOZXcgbm90aWZpY2F0aW9uIHRvIHNob3dcbiAgICovXG4gIHByaXZhdGUgY29udGludWVIYW5kbGVTaG93QWN0aW9uKG5vdGlmaWNhdGlvbjogTm90aWZpZXJOb3RpZmljYXRpb24pOiB2b2lkIHtcbiAgICAvLyBGaXJzdCAod2hpY2ggbWVhbnMgb25seSBvbmUpIG5vdGlmaWNhdGlvbiBpbiB0aGUgbGlzdD9cbiAgICBjb25zdCBudW1iZXJPZk5vdGlmaWNhdGlvbnM6IG51bWJlciA9IHRoaXMubm90aWZpY2F0aW9ucy5sZW5ndGg7XG4gICAgaWYgKG51bWJlck9mTm90aWZpY2F0aW9ucyA9PT0gMSkge1xuICAgICAgbm90aWZpY2F0aW9uLmNvbXBvbmVudC5zaG93KCkudGhlbih0aGlzLnRlbXBQcm9taXNlUmVzb2x2ZXIpOyAvLyBEb25lXG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGltcGxpY2l0U3RhY2tpbmdMaW1pdCA9IDI7XG5cbiAgICAgIC8vIFN0YWNraW5nIGVuYWJsZWQ/IChzdGFja2luZyB2YWx1ZSBiZWxvdyAyIG1lYW5zIHN0YWNraW5nIGlzIGRpc2FibGVkKVxuICAgICAgaWYgKHRoaXMuY29uZmlnLmJlaGF2aW91ci5zdGFja2luZyA9PT0gZmFsc2UgfHwgdGhpcy5jb25maWcuYmVoYXZpb3VyLnN0YWNraW5nIDwgaW1wbGljaXRTdGFja2luZ0xpbWl0KSB7XG4gICAgICAgIHRoaXMubm90aWZpY2F0aW9uc1swXS5jb21wb25lbnQuaGlkZSgpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgIHRoaXMucmVtb3ZlTm90aWZpY2F0aW9uRnJvbUxpc3QodGhpcy5ub3RpZmljYXRpb25zWzBdKTtcbiAgICAgICAgICBub3RpZmljYXRpb24uY29tcG9uZW50LnNob3coKS50aGVuKHRoaXMudGVtcFByb21pc2VSZXNvbHZlcik7IC8vIERvbmVcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBzdGVwUHJvbWlzZXM6IEFycmF5PFByb21pc2U8dm9pZD4+ID0gW107XG5cbiAgICAgICAgLy8gQXJlIHRoZXJlIG5vdyB0b28gbWFueSBub3RpZmljYXRpb25zP1xuICAgICAgICBpZiAobnVtYmVyT2ZOb3RpZmljYXRpb25zID4gdGhpcy5jb25maWcuYmVoYXZpb3VyLnN0YWNraW5nKSB7XG4gICAgICAgICAgY29uc3Qgb2xkTm90aWZpY2F0aW9uczogQXJyYXk8Tm90aWZpZXJOb3RpZmljYXRpb24+ID0gdGhpcy5ub3RpZmljYXRpb25zLnNsaWNlKDEsIG51bWJlck9mTm90aWZpY2F0aW9ucyAtIDEpO1xuXG4gICAgICAgICAgLy8gQXJlIGFuaW1hdGlvbnMgZW5hYmxlZD9cbiAgICAgICAgICBpZiAodGhpcy5jb25maWcuYW5pbWF0aW9ucy5lbmFibGVkKSB7XG4gICAgICAgICAgICAvLyBJcyBhbmltYXRpb24gb3ZlcmxhcCBlbmFibGVkP1xuICAgICAgICAgICAgaWYgKHRoaXMuY29uZmlnLmFuaW1hdGlvbnMub3ZlcmxhcCAhPT0gZmFsc2UgJiYgdGhpcy5jb25maWcuYW5pbWF0aW9ucy5vdmVybGFwID4gMCkge1xuICAgICAgICAgICAgICBzdGVwUHJvbWlzZXMucHVzaCh0aGlzLm5vdGlmaWNhdGlvbnNbMF0uY29tcG9uZW50LmhpZGUoKSk7XG4gICAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgIHN0ZXBQcm9taXNlcy5wdXNoKHRoaXMuc2hpZnROb3RpZmljYXRpb25zKG9sZE5vdGlmaWNhdGlvbnMsIG5vdGlmaWNhdGlvbi5jb21wb25lbnQuZ2V0SGVpZ2h0KCksIHRydWUpKTtcbiAgICAgICAgICAgICAgfSwgdGhpcy5jb25maWcuYW5pbWF0aW9ucy5oaWRlLnNwZWVkIC0gdGhpcy5jb25maWcuYW5pbWF0aW9ucy5vdmVybGFwKTtcbiAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgc3RlcFByb21pc2VzLnB1c2gobm90aWZpY2F0aW9uLmNvbXBvbmVudC5zaG93KCkpO1xuICAgICAgICAgICAgICB9LCB0aGlzLmNvbmZpZy5hbmltYXRpb25zLmhpZGUuc3BlZWQgKyB0aGlzLmNvbmZpZy5hbmltYXRpb25zLnNoaWZ0LnNwZWVkIC0gdGhpcy5jb25maWcuYW5pbWF0aW9ucy5vdmVybGFwKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHN0ZXBQcm9taXNlcy5wdXNoKFxuICAgICAgICAgICAgICAgIG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlOiAoKSA9PiB2b2lkKSA9PiB7XG4gICAgICAgICAgICAgICAgICB0aGlzLm5vdGlmaWNhdGlvbnNbMF0uY29tcG9uZW50LmhpZGUoKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaGlmdE5vdGlmaWNhdGlvbnMob2xkTm90aWZpY2F0aW9ucywgbm90aWZpY2F0aW9uLmNvbXBvbmVudC5nZXRIZWlnaHQoKSwgdHJ1ZSkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgbm90aWZpY2F0aW9uLmNvbXBvbmVudC5zaG93KCkudGhlbihyZXNvbHZlKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc3RlcFByb21pc2VzLnB1c2godGhpcy5ub3RpZmljYXRpb25zWzBdLmNvbXBvbmVudC5oaWRlKCkpO1xuICAgICAgICAgICAgc3RlcFByb21pc2VzLnB1c2godGhpcy5zaGlmdE5vdGlmaWNhdGlvbnMob2xkTm90aWZpY2F0aW9ucywgbm90aWZpY2F0aW9uLmNvbXBvbmVudC5nZXRIZWlnaHQoKSwgdHJ1ZSkpO1xuICAgICAgICAgICAgc3RlcFByb21pc2VzLnB1c2gobm90aWZpY2F0aW9uLmNvbXBvbmVudC5zaG93KCkpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zdCBvbGROb3RpZmljYXRpb25zOiBBcnJheTxOb3RpZmllck5vdGlmaWNhdGlvbj4gPSB0aGlzLm5vdGlmaWNhdGlvbnMuc2xpY2UoMCwgbnVtYmVyT2ZOb3RpZmljYXRpb25zIC0gMSk7XG5cbiAgICAgICAgICAvLyBBcmUgYW5pbWF0aW9ucyBlbmFibGVkP1xuICAgICAgICAgIGlmICh0aGlzLmNvbmZpZy5hbmltYXRpb25zLmVuYWJsZWQpIHtcbiAgICAgICAgICAgIC8vIElzIGFuaW1hdGlvbiBvdmVybGFwIGVuYWJsZWQ/XG4gICAgICAgICAgICBpZiAodGhpcy5jb25maWcuYW5pbWF0aW9ucy5vdmVybGFwICE9PSBmYWxzZSAmJiB0aGlzLmNvbmZpZy5hbmltYXRpb25zLm92ZXJsYXAgPiAwKSB7XG4gICAgICAgICAgICAgIHN0ZXBQcm9taXNlcy5wdXNoKHRoaXMuc2hpZnROb3RpZmljYXRpb25zKG9sZE5vdGlmaWNhdGlvbnMsIG5vdGlmaWNhdGlvbi5jb21wb25lbnQuZ2V0SGVpZ2h0KCksIHRydWUpKTtcbiAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgc3RlcFByb21pc2VzLnB1c2gobm90aWZpY2F0aW9uLmNvbXBvbmVudC5zaG93KCkpO1xuICAgICAgICAgICAgICB9LCB0aGlzLmNvbmZpZy5hbmltYXRpb25zLnNoaWZ0LnNwZWVkIC0gdGhpcy5jb25maWcuYW5pbWF0aW9ucy5vdmVybGFwKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHN0ZXBQcm9taXNlcy5wdXNoKFxuICAgICAgICAgICAgICAgIG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlOiAoKSA9PiB2b2lkKSA9PiB7XG4gICAgICAgICAgICAgICAgICB0aGlzLnNoaWZ0Tm90aWZpY2F0aW9ucyhvbGROb3RpZmljYXRpb25zLCBub3RpZmljYXRpb24uY29tcG9uZW50LmdldEhlaWdodCgpLCB0cnVlKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbm90aWZpY2F0aW9uLmNvbXBvbmVudC5zaG93KCkudGhlbihyZXNvbHZlKTtcbiAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBzdGVwUHJvbWlzZXMucHVzaCh0aGlzLnNoaWZ0Tm90aWZpY2F0aW9ucyhvbGROb3RpZmljYXRpb25zLCBub3RpZmljYXRpb24uY29tcG9uZW50LmdldEhlaWdodCgpLCB0cnVlKSk7XG4gICAgICAgICAgICBzdGVwUHJvbWlzZXMucHVzaChub3RpZmljYXRpb24uY29tcG9uZW50LnNob3coKSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgUHJvbWlzZS5hbGwoc3RlcFByb21pc2VzKS50aGVuKCgpID0+IHtcbiAgICAgICAgICBpZiAobnVtYmVyT2ZOb3RpZmljYXRpb25zID4gdGhpcy5jb25maWcuYmVoYXZpb3VyLnN0YWNraW5nKSB7XG4gICAgICAgICAgICB0aGlzLnJlbW92ZU5vdGlmaWNhdGlvbkZyb21MaXN0KHRoaXMubm90aWZpY2F0aW9uc1swXSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHRoaXMudGVtcFByb21pc2VSZXNvbHZlcigpO1xuICAgICAgICB9KTsgLy8gRG9uZVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBIaWRlIGFuIGV4aXN0aW5nIG5vdGlmaWNhdGlvblxuICAgKlxuICAgKiBGaXN0LCB3ZSBza2lwIGV2ZXJ5dGhpbmcgaWYgdGhlcmUgYXJlIG5vIG5vdGlmaWNhdGlvbnMgYXQgYWxsLCBvciB0aGUgZ2l2ZW4gbm90aWZpY2F0aW9uIGRvZXMgbm90IGV4aXN0LiBUaGVuLCB3ZSBoaWRlIHRoZSBnaXZlblxuICAgKiBub3RpZmljYXRpb24uIElmIHRoZXJlIGV4aXN0IG9sZGVyIG5vdGlmaWNhdGlvbnMsIHdlIHRoZW4gc2hpZnQgdGhlbSBhcm91bmQgdG8gZmlsbCB0aGUgZ2FwLiBPbmNlIGJvdGggaGlkaW5nIHRoZSBnaXZlbiBub3RpZmljYXRpb25cbiAgICogYW5kIHNoaWZ0aW5nIHRoZSBvbGRlciBub3RpZmljYWl0b25zIGlzIGRvbmUsIHRoZSBnaXZlbiBub3RpZmljYXRpb24gZ2V0cyBmaW5hbGx5IHJlbW92ZWQgKGZyb20gdGhlIERPTSkuXG4gICAqXG4gICAqIEBwYXJhbSAgIGFjdGlvbiBBY3Rpb24gb2JqZWN0LCBwYXlsb2FkIGNvbnRhaW5zIHRoZSBub3RpZmljYXRpb24gSURcbiAgICogQHJldHVybnMgUHJvbWlzZSwgcmVzb2x2ZWQgd2hlbiBkb25lXG4gICAqL1xuICBwcml2YXRlIGhhbmRsZUhpZGVBY3Rpb24oYWN0aW9uOiBOb3RpZmllckFjdGlvbik6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZTogKCkgPT4gdm9pZCkgPT4ge1xuICAgICAgY29uc3Qgc3RlcFByb21pc2VzOiBBcnJheTxQcm9taXNlPHZvaWQ+PiA9IFtdO1xuXG4gICAgICAvLyBEb2VzIHRoZSBub3RpZmljYXRpb24gZXhpc3QgLyBhcmUgdGhlcmUgZXZlbiBhbnkgbm90aWZpY2F0aW9ucz8gKGxldCdzIHByZXZlbnQgYWNjaWRlbnRpYWwgZXJyb3JzKVxuICAgICAgY29uc3Qgbm90aWZpY2F0aW9uOiBOb3RpZmllck5vdGlmaWNhdGlvbiB8IHVuZGVmaW5lZCA9IHRoaXMuZmluZE5vdGlmaWNhdGlvbkJ5SWQoYWN0aW9uLnBheWxvYWQpO1xuICAgICAgaWYgKG5vdGlmaWNhdGlvbiA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICAvLyBHZXQgb2xkZXIgbm90aWZpY2F0aW9uc1xuICAgICAgY29uc3Qgbm90aWZpY2F0aW9uSW5kZXg6IG51bWJlciB8IHVuZGVmaW5lZCA9IHRoaXMuZmluZE5vdGlmaWNhdGlvbkluZGV4QnlJZChhY3Rpb24ucGF5bG9hZCk7XG4gICAgICBpZiAobm90aWZpY2F0aW9uSW5kZXggPT09IHVuZGVmaW5lZCkge1xuICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGNvbnN0IG9sZE5vdGlmaWNhdGlvbnM6IEFycmF5PE5vdGlmaWVyTm90aWZpY2F0aW9uPiA9IHRoaXMubm90aWZpY2F0aW9ucy5zbGljZSgwLCBub3RpZmljYXRpb25JbmRleCk7XG5cbiAgICAgIC8vIERvIG9sZGVyIG5vdGlmaWNhdGlvbnMgZXhpc3QsIGFuZCB0aHVzIGRvIHdlIG5lZWQgdG8gc2hpZnQgb3RoZXIgbm90aWZpY2F0aW9ucyBhcyBhIGNvbnNlcXVlbmNlP1xuICAgICAgaWYgKG9sZE5vdGlmaWNhdGlvbnMubGVuZ3RoID4gMCkge1xuICAgICAgICAvLyBBcmUgYW5pbWF0aW9ucyBlbmFibGVkP1xuICAgICAgICBpZiAodGhpcy5jb25maWcuYW5pbWF0aW9ucy5lbmFibGVkICYmIHRoaXMuY29uZmlnLmFuaW1hdGlvbnMuaGlkZS5zcGVlZCA+IDApIHtcbiAgICAgICAgICAvLyBJcyBhbmltYXRpb24gb3ZlcmxhcCBlbmFibGVkP1xuICAgICAgICAgIGlmICh0aGlzLmNvbmZpZy5hbmltYXRpb25zLm92ZXJsYXAgIT09IGZhbHNlICYmIHRoaXMuY29uZmlnLmFuaW1hdGlvbnMub3ZlcmxhcCA+IDApIHtcbiAgICAgICAgICAgIHN0ZXBQcm9taXNlcy5wdXNoKG5vdGlmaWNhdGlvbi5jb21wb25lbnQuaGlkZSgpKTtcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICBzdGVwUHJvbWlzZXMucHVzaCh0aGlzLnNoaWZ0Tm90aWZpY2F0aW9ucyhvbGROb3RpZmljYXRpb25zLCBub3RpZmljYXRpb24uY29tcG9uZW50LmdldEhlaWdodCgpLCBmYWxzZSkpO1xuICAgICAgICAgICAgfSwgdGhpcy5jb25maWcuYW5pbWF0aW9ucy5oaWRlLnNwZWVkIC0gdGhpcy5jb25maWcuYW5pbWF0aW9ucy5vdmVybGFwKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgbm90aWZpY2F0aW9uLmNvbXBvbmVudC5oaWRlKCkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgIHN0ZXBQcm9taXNlcy5wdXNoKHRoaXMuc2hpZnROb3RpZmljYXRpb25zKG9sZE5vdGlmaWNhdGlvbnMsIG5vdGlmaWNhdGlvbi5jb21wb25lbnQuZ2V0SGVpZ2h0KCksIGZhbHNlKSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgc3RlcFByb21pc2VzLnB1c2gobm90aWZpY2F0aW9uLmNvbXBvbmVudC5oaWRlKCkpO1xuICAgICAgICAgIHN0ZXBQcm9taXNlcy5wdXNoKHRoaXMuc2hpZnROb3RpZmljYXRpb25zKG9sZE5vdGlmaWNhdGlvbnMsIG5vdGlmaWNhdGlvbi5jb21wb25lbnQuZ2V0SGVpZ2h0KCksIGZhbHNlKSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHN0ZXBQcm9taXNlcy5wdXNoKG5vdGlmaWNhdGlvbi5jb21wb25lbnQuaGlkZSgpKTtcbiAgICAgIH1cblxuICAgICAgLy8gV2FpdCB1bnRpbCBib3RoIGhpZGluZyBhbmQgc2hpZnRpbmcgaXMgZG9uZSwgdGhlbiByZW1vdmUgdGhlIG5vdGlmaWNhdGlvbiBmcm9tIHRoZSBsaXN0XG4gICAgICBQcm9taXNlLmFsbChzdGVwUHJvbWlzZXMpLnRoZW4oKCkgPT4ge1xuICAgICAgICB0aGlzLnJlbW92ZU5vdGlmaWNhdGlvbkZyb21MaXN0KG5vdGlmaWNhdGlvbik7XG4gICAgICAgIHJlc29sdmUoKTsgLy8gRG9uZVxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogSGlkZSB0aGUgb2xkZXN0IG5vdGlmaWNhdGlvbiAoYnJpZGdlIHRvIGhhbmRsZUhpZGVBY3Rpb24pXG4gICAqXG4gICAqIEBwYXJhbSAgIGFjdGlvbiBBY3Rpb24gb2JqZWN0XG4gICAqIEByZXR1cm5zIFByb21pc2UsIHJlc29sdmVkIHdoZW4gZG9uZVxuICAgKi9cbiAgcHJpdmF0ZSBoYW5kbGVIaWRlT2xkZXN0QWN0aW9uKGFjdGlvbjogTm90aWZpZXJBY3Rpb24pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvLyBBcmUgdGhlcmUgYW55IG5vdGlmaWNhdGlvbnM/IChwcmV2ZW50IGFjY2lkZW50aWFsIGVycm9ycylcbiAgICBpZiAodGhpcy5ub3RpZmljYXRpb25zLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlOiAoKSA9PiB2b2lkKSA9PiB7XG4gICAgICAgIHJlc29sdmUoKTtcbiAgICAgIH0pOyAvLyBEb25lXG4gICAgfSBlbHNlIHtcbiAgICAgIGFjdGlvbi5wYXlsb2FkID0gdGhpcy5ub3RpZmljYXRpb25zWzBdLmlkO1xuICAgICAgcmV0dXJuIHRoaXMuaGFuZGxlSGlkZUFjdGlvbihhY3Rpb24pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBIaWRlIHRoZSBuZXdlc3Qgbm90aWZpY2F0aW9uIChicmlkZ2UgdG8gaGFuZGxlSGlkZUFjdGlvbilcbiAgICpcbiAgICogQHBhcmFtICAgYWN0aW9uIEFjdGlvbiBvYmplY3RcbiAgICogQHJldHVybnMgUHJvbWlzZSwgcmVzb2x2ZWQgd2hlbiBkb25lXG4gICAqL1xuICBwcml2YXRlIGhhbmRsZUhpZGVOZXdlc3RBY3Rpb24oYWN0aW9uOiBOb3RpZmllckFjdGlvbik6IFByb21pc2U8dm9pZD4ge1xuICAgIC8vIEFyZSB0aGVyZSBhbnkgbm90aWZpY2F0aW9ucz8gKHByZXZlbnQgYWNjaWRlbnRpYWwgZXJyb3JzKVxuICAgIGlmICh0aGlzLm5vdGlmaWNhdGlvbnMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gbmV3IFByb21pc2U8dm9pZD4oKHJlc29sdmU6ICgpID0+IHZvaWQpID0+IHtcbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfSk7IC8vIERvbmVcbiAgICB9IGVsc2Uge1xuICAgICAgYWN0aW9uLnBheWxvYWQgPSB0aGlzLm5vdGlmaWNhdGlvbnNbdGhpcy5ub3RpZmljYXRpb25zLmxlbmd0aCAtIDFdLmlkO1xuICAgICAgcmV0dXJuIHRoaXMuaGFuZGxlSGlkZUFjdGlvbihhY3Rpb24pO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBIaWRlIGFsbCBub3RpZmljYXRpb25zIGF0IG9uY2VcbiAgICpcbiAgICogQHJldHVybnMgUHJvbWlzZSwgcmVzb2x2ZWQgd2hlbiBkb25lXG4gICAqL1xuICBwcml2YXRlIGhhbmRsZUhpZGVBbGxBY3Rpb24oKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlOiAoKSA9PiB2b2lkKSA9PiB7XG4gICAgICAvLyBBcmUgdGhlcmUgYW55IG5vdGlmaWNhdGlvbnM/IChwcmV2ZW50IGFjY2lkZW50aWFsIGVycm9ycylcbiAgICAgIGNvbnN0IG51bWJlck9mTm90aWZpY2F0aW9uczogbnVtYmVyID0gdGhpcy5ub3RpZmljYXRpb25zLmxlbmd0aDtcbiAgICAgIGlmIChudW1iZXJPZk5vdGlmaWNhdGlvbnMgPT09IDApIHtcbiAgICAgICAgcmVzb2x2ZSgpOyAvLyBEb25lXG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgLy8gQXJlIGFuaW1hdGlvbnMgZW5hYmxlZD9cbiAgICAgIGlmIChcbiAgICAgICAgdGhpcy5jb25maWcuYW5pbWF0aW9ucy5lbmFibGVkICYmXG4gICAgICAgIHRoaXMuY29uZmlnLmFuaW1hdGlvbnMuaGlkZS5zcGVlZCA+IDAgJiZcbiAgICAgICAgdGhpcy5jb25maWcuYW5pbWF0aW9ucy5oaWRlLm9mZnNldCAhPT0gZmFsc2UgJiZcbiAgICAgICAgdGhpcy5jb25maWcuYW5pbWF0aW9ucy5oaWRlLm9mZnNldCA+IDBcbiAgICAgICkge1xuICAgICAgICBmb3IgKGxldCBpOiBudW1iZXIgPSBudW1iZXJPZk5vdGlmaWNhdGlvbnMgLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgICAgIGNvbnN0IGFuaW1hdGlvbk9mZnNldDogbnVtYmVyID0gdGhpcy5jb25maWcucG9zaXRpb24udmVydGljYWwucG9zaXRpb24gPT09ICd0b3AnID8gbnVtYmVyT2ZOb3RpZmljYXRpb25zIC0gMSA6IGk7XG4gICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLm5vdGlmaWNhdGlvbnNbaV0uY29tcG9uZW50LmhpZGUoKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgLy8gQXJlIHdlIGRvbmUgaGVyZSwgd2FzIHRoaXMgdGhlIGxhc3Qgbm90aWZpY2F0aW9uIHRvIGJlIGhpZGRlbj9cbiAgICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgICh0aGlzLmNvbmZpZy5wb3NpdGlvbi52ZXJ0aWNhbC5wb3NpdGlvbiA9PT0gJ3RvcCcgJiYgaSA9PT0gMCkgfHxcbiAgICAgICAgICAgICAgICAodGhpcy5jb25maWcucG9zaXRpb24udmVydGljYWwucG9zaXRpb24gPT09ICdib3R0b20nICYmIGkgPT09IG51bWJlck9mTm90aWZpY2F0aW9ucyAtIDEpXG4gICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlQWxsTm90aWZpY2F0aW9uc0Zyb21MaXN0KCk7XG4gICAgICAgICAgICAgICAgcmVzb2x2ZSgpOyAvLyBEb25lXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0sIHRoaXMuY29uZmlnLmFuaW1hdGlvbnMuaGlkZS5vZmZzZXQgKiBhbmltYXRpb25PZmZzZXQpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBzdGVwUHJvbWlzZXM6IEFycmF5PFByb21pc2U8dm9pZD4+ID0gW107XG4gICAgICAgIGZvciAobGV0IGk6IG51bWJlciA9IG51bWJlck9mTm90aWZpY2F0aW9ucyAtIDE7IGkgPj0gMDsgaS0tKSB7XG4gICAgICAgICAgc3RlcFByb21pc2VzLnB1c2godGhpcy5ub3RpZmljYXRpb25zW2ldLmNvbXBvbmVudC5oaWRlKCkpO1xuICAgICAgICB9XG4gICAgICAgIFByb21pc2UuYWxsKHN0ZXBQcm9taXNlcykudGhlbigoKSA9PiB7XG4gICAgICAgICAgdGhpcy5yZW1vdmVBbGxOb3RpZmljYXRpb25zRnJvbUxpc3QoKTtcbiAgICAgICAgICByZXNvbHZlKCk7IC8vIERvbmVcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogU2hpZnQgbXVsdGlwbGUgbm90aWZpY2F0aW9ucyBhdCBvbmNlXG4gICAqXG4gICAqIEBwYXJhbSAgIG5vdGlmaWNhdGlvbnMgTGlzdCBjb250YWluaW5nIHRoZSBub3RpZmljYXRpb25zIHRvIGJlIHNoaWZ0ZWRcbiAgICogQHBhcmFtICAgZGlzdGFuY2UgICAgICBEaXN0YW5jZSB0byBzaGlmdCAoaW4gcHgpXG4gICAqIEBwYXJhbSAgIHRvTWFrZVBsYWNlICAgRmxhZywgZGVmaW5pbmcgaW4gd2hpY2ggZGlyZWNpdG9uIHRvIHNoaWZ0XG4gICAqIEByZXR1cm5zIFByb21pc2UsIHJlc29sdmVkIHdoZW4gZG9uZVxuICAgKi9cbiAgcHJpdmF0ZSBzaGlmdE5vdGlmaWNhdGlvbnMobm90aWZpY2F0aW9uczogQXJyYXk8Tm90aWZpZXJOb3RpZmljYXRpb24+LCBkaXN0YW5jZTogbnVtYmVyLCB0b01ha2VQbGFjZTogYm9vbGVhbik6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTx2b2lkPigocmVzb2x2ZTogKCkgPT4gdm9pZCkgPT4ge1xuICAgICAgLy8gQXJlIHRoZXJlIGFueSBub3RpZmljYXRpb25zIHRvIHNoaWZ0P1xuICAgICAgaWYgKG5vdGlmaWNhdGlvbnMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBub3RpZmljYXRpb25Qcm9taXNlczogQXJyYXk8UHJvbWlzZTx2b2lkPj4gPSBbXTtcbiAgICAgIGZvciAobGV0IGk6IG51bWJlciA9IG5vdGlmaWNhdGlvbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgICAgbm90aWZpY2F0aW9uUHJvbWlzZXMucHVzaChub3RpZmljYXRpb25zW2ldLmNvbXBvbmVudC5zaGlmdChkaXN0YW5jZSwgdG9NYWtlUGxhY2UpKTtcbiAgICAgIH1cbiAgICAgIFByb21pc2UuYWxsKG5vdGlmaWNhdGlvblByb21pc2VzKS50aGVuKHJlc29sdmUpOyAvLyBEb25lXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogQWRkIGEgbmV3IG5vdGlmaWNhdGlvbiB0byB0aGUgbGlzdCBvZiBub3RpZmljYXRpb25zICh0cmlnZ2VycyBjaGFuZ2UgZGV0ZWN0aW9uKVxuICAgKlxuICAgKiBAcGFyYW0gbm90aWZpY2F0aW9uIE5vdGlmaWNhdGlvbiB0byBhZGQgdG8gdGhlIGxpc3Qgb2Ygbm90aWZpY2F0aW9uc1xuICAgKi9cbiAgcHJpdmF0ZSBhZGROb3RpZmljYXRpb25Ub0xpc3Qobm90aWZpY2F0aW9uOiBOb3RpZmllck5vdGlmaWNhdGlvbik6IHZvaWQge1xuICAgIHRoaXMubm90aWZpY2F0aW9ucy5wdXNoKG5vdGlmaWNhdGlvbik7XG4gICAgdGhpcy5jaGFuZ2VEZXRlY3Rvci5tYXJrRm9yQ2hlY2soKTsgLy8gUnVuIGNoYW5nZSBkZXRlY3Rpb24gYmVjYXVzZSB0aGUgbm90aWZpY2F0aW9uIGxpc3QgY2hhbmdlZFxuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSBhbiBleGlzdGluZyBub3RpZmljYXRpb24gZnJvbSB0aGUgbGlzdCBvZiBub3RpZmljYXRpb25zICh0cmlnZ2VycyBjaGFuZ2UgZGV0ZWN0aW9uKVxuICAgKlxuICAgKiBAcGFyYW0gbm90aWZpY2F0aW9uIE5vdGlmaWNhdGlvbiB0byBiZSByZW1vdmVkIGZyb20gdGhlIGxpc3Qgb2Ygbm90aWZpY2F0aW9uc1xuICAgKi9cbiAgcHJpdmF0ZSByZW1vdmVOb3RpZmljYXRpb25Gcm9tTGlzdChub3RpZmljYXRpb246IE5vdGlmaWVyTm90aWZpY2F0aW9uKTogdm9pZCB7XG4gICAgdGhpcy5ub3RpZmljYXRpb25zID0gdGhpcy5ub3RpZmljYXRpb25zLmZpbHRlcigoaXRlbTogTm90aWZpZXJOb3RpZmljYXRpb24pID0+IGl0ZW0uY29tcG9uZW50ICE9PSBub3RpZmljYXRpb24uY29tcG9uZW50KTtcbiAgICB0aGlzLmNoYW5nZURldGVjdG9yLm1hcmtGb3JDaGVjaygpOyAvLyBSdW4gY2hhbmdlIGRldGVjdGlvbiBiZWNhdXNlIHRoZSBub3RpZmljYXRpb24gbGlzdCBjaGFuZ2VkXG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIGFsbCBub3RpZmljYXRpb25zIGZyb20gdGhlIGxpc3QgKHRyaWdnZXJzIGNoYW5nZSBkZXRlY3Rpb24pXG4gICAqL1xuICBwcml2YXRlIHJlbW92ZUFsbE5vdGlmaWNhdGlvbnNGcm9tTGlzdCgpOiB2b2lkIHtcbiAgICB0aGlzLm5vdGlmaWNhdGlvbnMgPSBbXTtcbiAgICB0aGlzLmNoYW5nZURldGVjdG9yLm1hcmtGb3JDaGVjaygpOyAvLyBSdW4gY2hhbmdlIGRldGVjdGlvbiBiZWNhdXNlIHRoZSBub3RpZmljYXRpb24gbGlzdCBjaGFuZ2VkXG4gIH1cblxuICAvKipcbiAgICogSGVscGVyOiBGaW5kIGEgbm90aWZpY2F0aW9uIGluIHRoZSBub3RpZmljYXRpb24gbGlzdCBieSBhIGdpdmVuIG5vdGlmaWNhdGlvbiBJRFxuICAgKlxuICAgKiBAcGFyYW0gICBub3RpZmljYXRpb25JZCBOb3RpZmljYXRpb24gSUQsIHVzZWQgZm9yIGZpbmRpbmcgbm90aWZpY2F0aW9uXG4gICAqIEByZXR1cm5zIE5vdGlmaWNhdGlvbiwgdW5kZWZpbmVkIGlmIG5vdCBmb3VuZFxuICAgKi9cbiAgcHJpdmF0ZSBmaW5kTm90aWZpY2F0aW9uQnlJZChub3RpZmljYXRpb25JZDogc3RyaW5nKTogTm90aWZpZXJOb3RpZmljYXRpb24gfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLm5vdGlmaWNhdGlvbnMuZmluZCgoY3VycmVudE5vdGlmaWNhdGlvbjogTm90aWZpZXJOb3RpZmljYXRpb24pID0+IGN1cnJlbnROb3RpZmljYXRpb24uaWQgPT09IG5vdGlmaWNhdGlvbklkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBIZWxwZXI6IEZpbmQgYSBub3RpZmljYXRpb24ncyBpbmRleCBieSBhIGdpdmVuIG5vdGlmaWNhdGlvbiBJRFxuICAgKlxuICAgKiBAcGFyYW0gICBub3RpZmljYXRpb25JZCBOb3RpZmljYXRpb24gSUQsIHVzZWQgZm9yIGZpbmRpbmcgYSBub3RpZmljYXRpb24ncyBpbmRleFxuICAgKiBAcmV0dXJucyBOb3RpZmljYXRpb24gaW5kZXgsIHVuZGVmaW5lZCBpZiBub3QgZm91bmRcbiAgICovXG4gIHByaXZhdGUgZmluZE5vdGlmaWNhdGlvbkluZGV4QnlJZChub3RpZmljYXRpb25JZDogc3RyaW5nKTogbnVtYmVyIHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCBub3RpZmljYXRpb25JbmRleDogbnVtYmVyID0gdGhpcy5ub3RpZmljYXRpb25zLmZpbmRJbmRleChcbiAgICAgIChjdXJyZW50Tm90aWZpY2F0aW9uOiBOb3RpZmllck5vdGlmaWNhdGlvbikgPT4gY3VycmVudE5vdGlmaWNhdGlvbi5pZCA9PT0gbm90aWZpY2F0aW9uSWQsXG4gICAgKTtcbiAgICByZXR1cm4gbm90aWZpY2F0aW9uSW5kZXggIT09IC0xID8gbm90aWZpY2F0aW9uSW5kZXggOiB1bmRlZmluZWQ7XG4gIH1cbn1cbiJdfQ==